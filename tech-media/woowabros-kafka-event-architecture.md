# Kafka를 활용한 이벤트 기반 아키텍처 구축

> 아래 글은 우아한형제들의 우아콘 2023에서 발표한 [해당 영상](https://www.youtube.com/watch?v=DY3sUeGu74M)을 듣고 정리한 글입니다.
> 
> 영상 날짜: 2023. 12. 22

## 왜 이벤트 기반 아키텍처를 사용했나?

딜리버리 조직의 목표는 배달을 잘하는 것이다.

서비스 초기에는 '배달' 도메인만 집중했지만, 이후 연관된 다른 도메인과 여러 요구사항으로 인해 시스템 복잡성이 커졌고 강결합 문제가 발생했다.
- '배달' 도메인 외 다른 연관된 도메인 중 일부 도메인(쿠폰, 통계)은 강한 일관성을 보장하지 않아도 된다.

이러한 강결합 문제를 해결하고 결과적 일관성을 보장하기 위해 이벤트 기반 아키텍처를 선택하게 되었다.

이벤트의 구성요소는 크게 네 가지 요소로 나눈다.
- 대상, 행동, 정보, 시간

이러한 네 가지 요소를 바탕으로 다양한 도메인의 이벤트를 표현할 수 있고, 이를 코드에 적용했다.

이렇게 이벤트 기반 아키텍처 적용 후에 배달 시스템에 대한 복잡도가 줄어들었고, 강한 결합 문제를 해결했다.

또한, 데이터 분석에도 활용할 수 있게 했다.
- 언제 배달이 생성되고 누구에게 배차가 되고 어느 과정을 거쳐 배달이 완료되었는지 -> 도메인 히스토리 파악 가능

이벤트 기반 아키텍처를 사용하면서 주의할 점도 존재한다.
- 행위자 기반의 데이터 정의가 필요하고, 소비처 요구사항에 대한 무분별한 데이터 추가를 주의한다.
- 이벤트의 순서가 중요하다 (배달 생성 -> 배차 완료 -> 픽업 완료 -> 배달 완료)


## 이벤트 파이프라인

이벤트 파이프라인을 위해 `Kafka` 를 선택했다.

Kafka 를 선택한 이유: 순서 보장, 고성능/고가용성, 통합 도구, 전담팀 지원
- 순서 보장: 토픽의 파티션을 통해 Key 별로 순서를 보장할 수 있다. (Key - 배달 번호)
- 고성능/고가용성: 실시간 많은 이벤트를 처리하기 위해 필요하다.
- 통합 도구: Kafka Streams, Kafka Connect 등 다양한 통합 도구를 제공한다.
- 전담 팀 지원: 카프카 클러스터 관리, 모니터링 및 지원도구 제공 (카프카 팀이 따로 존재했음)

Kafka 를 도입하면서 예기치 못한 문제가 발생했다.
- 네트워크 이슈, 브로커 이슈 등 이벤트 발행이 실패가 되거나 재시도 처리로 인해 도메인의 상태와 이벤트 발행 결과 간의 불일치 문제가 발생했다.
- 이러한 문제를 해결하기 위해 `Transactional outbox Pattern` 을 도입하게 되었다.
  - 해당 기술을 통해 이벤트 유실과 이벤트 순서 변경에 대한 문제를 해결할 수 있다고 생각했다.
- 이러한 패턴을 도입하면서 `Message Relay` 를 구현해야 했고, 세 가지를 고려했다.
  - 저비용, 안전성, 처리량
  - 직접 구현 대신 오픈소스 플랫폼에서 제공되는 `Debezium` 을 사용했다. -> CDC에서 자주 사용되는 도구
- 이를 통해 이벤트 유실 없이 순서를 보장하는 이벤트 기반 아키텍처를 구축할 수 있었다.

## 이벤트의 활용 사례

순서가 보장된 이벤트는 이벤트 스트림을 구성한다. -> 시스템 개선이나 확장성에 도움이 된다.

찻 번째는 CQRS를 적용했다.
- 대량의 데이터를 조회하기 위해 쿼리 모델을 구축했다.
- 기존의 조회 기능을 쿼리 모델에 사용함으로써 장애가 발생해도 Command 쪽에 영향이 가지 않도록 했다.

두 번째로 데이터 분석 환경을 구축했다.
- 배경: 서비스를 운영하다보면 이슈 대응, 모니터링, 성과 분석을 위해 데이터 분석이 필요했다.
- AWS 기반으로 데이터를 S3 저장 -> 이후 데이터 분석을 위해 AWS Glue, Athena를 활용했다.
- 그리고 다른 팀이 '배달' 도메인에 대한 데이터를 분석할 수 있도록 -> Airflow, (전사적으로 사용하는) DataLake 에 연동했다. 

마지막으로 실시간 배달과 라이더 수를 집계하고 모니터링하기 위해 스트림즈 애플리케이션을 구현했다.
- 기존에는 배치 작업으로 구현했으나, 실시간성을 보장받지 못했다.
- Kafka Streams 를 통해 실시간으로 다양한 지표를 집계해서 모니터링 환경을 구축했다.
